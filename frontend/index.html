<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg,#1e3c72,#2a5298);
            color:#fff;
            min-height:100vh;
        }
        h1{
            background: linear-gradient(90deg,#ff8a00,#e52e71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            background-color: rgba(255,255,255,0.1);
            border:none;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        table{color:#fff;}
    </style>
</head>
<body>
<div class="container py-4">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Model Dashboard</h1>
        <div class="d-flex justify-content-center align-items-center mt-3">
            <select id="model-select" class="form-select w-auto me-2">
                <option value="xgboost">XGBoost</option>
                <option value="randomforest">Random Forest</option>
                <option value="bilstm">BiLSTM</option>
                <option value="transformer">Transformer</option>
            </select>
            <button class="btn btn-warning" onclick="loadDashboard()">Load Data</button>
        </div>
    </div>

    <div class="card mb-4 p-3">
        <h2 class="h4">Metrics</h2>
        <div id="metrics"></div>
    </div>

    <div class="card mb-4 p-3">
        <h2 class="h4">Feature Importance</h2>
        <canvas id="fi-chart"></canvas>
    </div>

    <div class="card mb-4 p-3">
        <h2 class="h4">Residuals</h2>
        <canvas id="residuals-chart"></canvas>
    </div>

    <div class="card mb-4 p-3">
        <h2 class="h4">Predictions</h2>
        <canvas id="predictions-chart"></canvas>
    </div>
</div>

<script>
async function fetchData(endpoint, model) {
    const res = await fetch(`http://localhost:8000/${endpoint}/${model}`);
    return res.json();
}

function renderTable(data) {
    if (!data.length) return '<p>No data</p>';
    const headers = Object.keys(data[0]);
    let html = '<table class="table table-striped">';
    html += '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
    data.forEach(r => {
        html += '<tr>' + headers.map(h => `<td>${r[h]}</td>`).join('') + '</tr>';
    });
    html += '</tbody></table>';
    return html;
}

function prepareChartData(data, xKey) {
    const keys = Object.keys(data[0]).filter(k => k !== xKey);
    const labels = data.map(d => d[xKey] ?? data.indexOf(d));
    const colors = ['#ff6384','#36a2eb','#cc65fe','#ffce56','#00d4b2'];
    const datasets = keys.map((k,i)=>({
        label:k,
        data:data.map(d=>d[k]),
        borderColor:colors[i%colors.length],
        backgroundColor:colors[i%colors.length],
        fill:false,
        tension:0.1
    }));
    return {labels,datasets};
}

let charts = {};
function renderChart(id,type,data,xKey){
    const ctx=document.getElementById(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    const chartData=prepareChartData(data,xKey);
    charts[id]=new Chart(ctx,{type,data:chartData,options:{responsive:true,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}}}});
}

async function loadDashboard(){
    const model=document.getElementById('model-select').value;
    const metrics=await fetchData('metrics',model);
    document.getElementById('metrics').innerHTML=renderTable(metrics);

    const fiObj=await fetchData('feature-importance',model);
    const fiData=Object.entries(fiObj).map(([f,i])=>({feature:f,importance:i}));
    renderChart('fi-chart','bar',fiData,'feature');

    const residuals=await fetchData('residuals',model);
    renderChart('residuals-chart','line',residuals,'index');

    const predictions=await fetchData('predictions',model);
    renderChart('predictions-chart','line',predictions,'year');
}
</script>
</body>
</html>
